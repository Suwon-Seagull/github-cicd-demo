# 워크플로우의 전체 이름을 정의합니다. GitHub의 "Actions" 탭에 이 이름이 표시됩니다.
name: Java CI with Gradle and Docker

# 'on'은 이 워크플로우를 언제 실행할지 결정하는 트리거(trigger)를 정의합니다.
on:
  # 'push' 이벤트에 대해 설정합니다.
  push:
    # 'main' 또는 'master' 브랜치에 코드가 푸시될 때 워크플로우를 실행합니다.
    branches: [ "main", "master" ]
  # 'pull_request' 이벤트에 대해 설정합니다.
  pull_request:
    # 'main' 또는 'master' 브랜치를 대상으로 하는 Pull Request가 생성되거나 업데이트될 때 워크플로우를 실행합니다.
    branches: [ "main", "master" ]

# 'jobs'는 워크플로우에서 실행될 하나 이상의 작업(job)들을 정의합니다.
jobs:
  # 'build-and-push-docker'는 이 작업의 고유 ID입니다. 원하는 이름으로 설정할 수 있습니다.
  build-and-push-docker:
    # 'runs-on'은 이 작업을 실행할 가상 머신 환경을 지정합니다.
    # 'ubuntu-latest'는 GitHub가 제공하는 최신 버전의 Ubuntu 리눅스 환경을 사용하겠다는 의미입니다.
    runs-on: ubuntu-latest

    # 'steps'는 작업 안에서 순차적으로 실행될 단계(step)들의 목록입니다.
    steps:
    # 첫 번째 단계: 코드 체크아웃
    # 'name'은 이 단계의 이름을 지정합니다. Actions 탭의 UI에 표시됩니다.
    - name: Checkout code
      # 'uses'는 다른 사람이 만들어서 공유해놓은 액션(Action)을 사용하겠다는 의미입니다.
      # 'actions/checkout@v4'는 GitHub 공식 체크아웃 액션의 4번째 버전입니다.
      # 이 액션은 워크플로우를 실행하는 리포지토리의 코드를 가상 머신으로 가져오는 역할을 합니다.
      uses: actions/checkout@v4

    # 두 번째 단계: JDK 설정
    - name: Set up JDK 21
      # 'actions/setup-java@v4'는 특정 버전의 Java(JDK)를 가상 머신에 설치해주는 공식 액션입니다.
      uses: actions/setup-java@v4
      # 'with'는 해당 액션에 필요한 파라미터들을 전달할 때 사용합니다.
      with:
        # 'java-version' 파라미터: 설치할 JDK 버전을 지정합니다. '21'로 설정하여 Java 21을 사용합니다.
        java-version: '21'
        # 'distribution' 파라미터: 사용할 JDK 배포판을 지정합니다. 'temurin'은 Eclipse Temurin 배포판을 의미합니다.
        distribution: 'temurin'
        # 'cache' 파라미터: 의존성(dependency) 캐싱 설정을 합니다. 'gradle'로 설정하면
        # 다운로드한 Gradle 라이브러리들을 캐싱하여 다음 빌드부터는 더 빠르게 실행할 수 있습니다.
        cache: 'gradle'

    # 세 번째 단계: gradlew 실행 권한 부여
    - name: Grant execute permission for gradlew
      # 'run'은 특정 셸 명령어를 직접 실행할 때 사용합니다.
      # 'chmod +x gradlew'는 리눅스/macOS 환경에서 gradlew 파일에 실행 권한을 부여하는 명령어입니다.
      # 이 권한이 없으면 다음 단계에서 gradlew를 실행할 수 없어 빌드가 실패합니다.
      run: chmod +x gradlew

    # 네 번째 단계: Gradle로 빌드
    - name: Build with Gradle
      # './gradlew build'는 Gradle Wrapper를 사용하여 프로젝트를 빌드하는 명령어입니다.
      # 이 과정에서 자동으로 테스트도 함께 실행됩니다. 빌드가 성공하면 build/libs/ 아래에 .jar 파일이 생성됩니다.
      run: ./gradlew build

    # 다섯 번째 단계: Docker Hub에 로그인
    # (참고: 이 단계는 GitHub Secrets 설정이 완료되어야 성공적으로 실행됩니다.)
    - name: Log in to Docker Hub
      # 'docker/login-action@v3'는 Docker Hub와 같은 컨테이너 레지스트리에 로그인하는 공식 액션입니다.
      uses: docker/login-action@v3
      with:
        # 'username' 파라미터: Docker Hub 사용자 이름을 전달합니다.
        # '${{ secrets.DOCKER_USERNAME }}'는 GitHub Secrets에 저장된 DOCKER_USERNAME 값을 안전하게 가져오는 구문입니다.
        username: ${{ secrets.DOCKER_USERNAME }}
        # 'password' 파라미터: Docker Hub 비밀번호 또는 Access Token을 전달합니다.
        # '${{ secrets.DOCKER_PASSWORD }}'는 GitHub Secrets에 저장된 DOCKER_PASSWORD 값을 안전하게 가져오는 구문입니다.
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 여섯 번째 단계: Docker 이미지 빌드 및 푸시
    # (참고: 이 단계는 GitHub Secrets 설정이 완료되어야 성공적으로 실행됩니다.)
    - name: Build and push Docker image
      # 'docker/build-push-action@v5'는 Docker 이미지를 빌드하고 레지스트리로 푸시하는 과정을 자동화해주는 공식 액션입니다.
      uses: docker/build-push-action@v5
      with:
        # Docker 빌드 시점에 전달할 인자들을 정의합니다.
        build-args: |
          COMMIT_ID=${{ github.sha }}
        # 'context' 파라미터: Dockerfile이 있는 컨텍스트 경로를 지정합니다. '.'는 현재 디렉토리(프로젝트 루트)를 의미합니다.
        context: .
        # 'push' 파라미터: 빌드된 이미지를 레지스트리로 푸시할지 여부를 결정합니다. 'true'로 설정하면 푸시합니다.
        push: true
        # 'tags' 파라미터: 생성될 Docker 이미지의 이름과 태그를 지정합니다.
        # 보통 '[Docker Hub 사용자 이름]/[이미지 이름]:[태그]' 형식으로 작성합니다.
        # 'latest' 태그는 가장 최신 버전을 의미합니다.
        tags: ${{ secrets.DOCKER_USERNAME }}/github-cicd-demo:latest

  # 'deploy'는 배포 작업의 고유 ID입니다.
  deploy:
    # 'needs'는 이 작업이 의존하는 다른 작업을 지정합니다.
    # 'build-and-push-docker' 작업이 성공적으로 완료되어야 이 작업이 시작됩니다.
    needs: build-and-push-docker
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to Server
      # 'appleboy/ssh-action'은 SSH를 통해 원격 서버에 접속하고 명령어를 실행해주는 인기있는 액션입니다.
      uses: appleboy/ssh-action@master
      with:
        # 'host': 접속할 서버의 IP 주소 또는 도메인 이름입니다. GitHub Secrets에서 값을 가져옵니다.
        host: ${{ secrets.SERVER_HOST }}
        # 'username': 서버에 로그인할 사용자 이름입니다.
        username: ${{ secrets.SERVER_USERNAME }}
        # 'key': SSH 접속에 사용할 개인 키(Private Key)입니다. 보안을 위해 반드시 Secrets에 저장해야 합니다.
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        # 'script': 원격 서버에서 실행할 셸 스크립트입니다.
        script: |
          # 1. Docker Hub에서 최신 이미지를 받아옵니다.
          docker pull ${{ secrets.DOCKER_USERNAME }}/github-cicd-demo:latest

          # 2. 기존에 실행 중인 컨테이너가 있다면 중지하고 삭제합니다.
          # '|| true'는 컨테이너가 없어서 명령어가 실패하더라도, 전체 스크립트가 중단되지 않고 계속 진행되도록 합니다.
          docker stop github-cicd-app || true
          docker rm github-cicd-app || true

          # 3. 새로 받은 이미지로 컨테이너를 실행합니다.
          # -d: 백그라운드에서 실행
          # --name: 컨테이너에 'github-cicd-app'이라는 고유한 이름을 부여
          # -p 80:8080: 서버의 80번 포트를 컨테이너의 8080 포트와 연결합니다. (예: http://서버IP/ 로 접속 가능)
          # --restart always: 예기치 않게 컨테이너가 종료되면 Docker가 자동으로 다시 시작시켜주는 옵션입니다.
          docker run -d --restart always --name github-cicd-app -p 49080:8080 ${{ secrets.DOCKER_USERNAME }}/github-cicd-demo:latest