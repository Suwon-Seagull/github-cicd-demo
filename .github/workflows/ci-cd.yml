# 워크플로우의 전체 이름을 정의합니다. GitHub의 "Actions" 탭에 이 이름이 표시됩니다.
name: Java CI with Gradle and Docker

# 'on'은 이 워크플로우를 언제 실행할지 결정하는 트리거(trigger)를 정의합니다.
on:
  # 'push' 이벤트에 대해 설정합니다.
  push:
    # 'main' 또는 'master' 브랜치에 코드가 푸시될 때 워크플로우를 실행합니다.
    branches: [ "main", "master" ]
  # 'pull_request' 이벤트에 대해 설정합니다.
  pull_request:
    # 'main' 또는 'master' 브랜치를 대상으로 하는 Pull Request가 생성되거나 업데이트될 때 워크플로우를 실행합니다.
    branches: [ "main", "master" ]

# 'jobs'는 워크플로우에서 실행될 하나 이상의 작업(job)들을 정의합니다.
jobs:
  # 'build-and-push-docker'는 이 작업의 고유 ID입니다. 원하는 이름으로 설정할 수 있습니다.
  build-and-push-docker:
    # 'runs-on'은 이 작업을 실행할 가상 머신 환경을 지정합니다.
    # 'ubuntu-latest'는 GitHub가 제공하는 최신 버전의 Ubuntu 리눅스 환경을 사용하겠다는 의미입니다.
    runs-on: ubuntu-latest

    # 'steps'는 작업 안에서 순차적으로 실행될 단계(step)들의 목록입니다.
    steps:
    # 첫 번째 단계: 코드 체크아웃
    # 'name'은 이 단계의 이름을 지정합니다. Actions 탭의 UI에 표시됩니다.
    - name: Checkout code
      # 'uses'는 다른 사람이 만들어서 공유해놓은 액션(Action)을 사용하겠다는 의미입니다.
      # 'actions/checkout@v4'는 GitHub 공식 체크아웃 액션의 4번째 버전입니다.
      # 이 액션은 워크플로우를 실행하는 리포지토리의 코드를 가상 머신으로 가져오는 역할을 합니다.
      uses: actions/checkout@v4

    # 두 번째 단계: JDK 설정
    - name: Set up JDK 21
      # 'actions/setup-java@v4'는 특정 버전의 Java(JDK)를 가상 머신에 설치해주는 공식 액션입니다.
      uses: actions/setup-java@v4
      # 'with'는 해당 액션에 필요한 파라미터들을 전달할 때 사용합니다.
      with:
        # 'java-version' 파라미터: 설치할 JDK 버전을 지정합니다. '21'로 설정하여 Java 21을 사용합니다.
        java-version: '21'
        # 'distribution' 파라미터: 사용할 JDK 배포판을 지정합니다. 'temurin'은 Eclipse Temurin 배포판을 의미합니다.
        distribution: 'temurin'
        # 'cache' 파라미터: 의존성(dependency) 캐싱 설정을 합니다. 'gradle'로 설정하면
        # 다운로드한 Gradle 라이브러리들을 캐싱하여 다음 빌드부터는 더 빠르게 실행할 수 있습니다.
        cache: 'gradle'

    # 세 번째 단계: gradlew 실행 권한 부여
    - name: Grant execute permission for gradlew
      # 'run'은 특정 셸 명령어를 직접 실행할 때 사용합니다.
      # 'chmod +x gradlew'는 리눅스/macOS 환경에서 gradlew 파일에 실행 권한을 부여하는 명령어입니다.
      # 이 권한이 없으면 다음 단계에서 gradlew를 실행할 수 없어 빌드가 실패합니다.
      run: chmod +x gradlew

    # 네 번째 단계: Gradle로 빌드
    - name: Build with Gradle
      # './gradlew build'는 Gradle Wrapper를 사용하여 프로젝트를 빌드하는 명령어입니다.
      # 이 과정에서 자동으로 테스트도 함께 실행됩니다. 빌드가 성공하면 build/libs/ 아래에 .jar 파일이 생성됩니다.
      run: ./gradlew build

    # 다섯 번째 단계: Docker Hub에 로그인
    # (참고: 이 단계는 GitHub Secrets 설정이 완료되어야 성공적으로 실행됩니다.)
    - name: Log in to Docker Hub
      # 'docker/login-action@v3'는 Docker Hub와 같은 컨테이너 레지스트리에 로그인하는 공식 액션입니다.
      uses: docker/login-action@v3
      with:
        # 'username' 파라미터: Docker Hub 사용자 이름을 전달합니다.
        # '${{ secrets.DOCKER_USERNAME }}'는 GitHub Secrets에 저장된 DOCKER_USERNAME 값을 안전하게 가져오는 구문입니다.
        username: ${{ secrets.DOCKER_USERNAME }}
        # 'password' 파라미터: Docker Hub 비밀번호 또는 Access Token을 전달합니다.
        # '${{ secrets.DOCKER_PASSWORD }}'는 GitHub Secrets에 저장된 DOCKER_PASSWORD 값을 안전하게 가져오는 구문입니다.
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 여섯 번째 단계: Docker 이미지 빌드 및 푸시
    # (참고: 이 단계는 GitHub Secrets 설정이 완료되어야 성공적으로 실행됩니다.)
    - name: Build and push Docker image
      # 'docker/build-push-action@v5'는 Docker 이미지를 빌드하고 레지스트리로 푸시하는 과정을 자동화해주는 공식 액션입니다.
      uses: docker/build-push-action@v5
      with:
        # 'context' 파라미터: Dockerfile이 위치한 경로를 지정합니다. '.'는 현재 디렉토리(프로젝트 루트)를 의미합니다.
        context: .
        # 'push' 파라미터: 빌드된 이미지를 레지스트리로 푸시할지 여부를 결정합니다. 'true'로 설정하면 푸시합니다.
        push: true
        # 'tags' 파라미터: 생성될 Docker 이미지의 이름과 태그를 지정합니다.
        # 보통 '[Docker Hub 사용자 이름]/[이미지 이름]:[태그]' 형식으로 작성합니다.
        # 'latest' 태그는 가장 최신 버전을 의미합니다.
        tags: ${{ secrets.DOCKER_USERNAME }}/github-cicd-demo:latest